# Quanta II 程式開發說明

## 專案概述
Quanta II 是一個量化交易策略開發與回測系統，提供完整的策略開發、回測和績效分析功能。

## 系統架構
系統分為四個主要模組：
1. M0: 歷史資料下載模組
2. M1: 策略信號產生模組
3. M2: 策略回測模組
4. M3: 績效篩選與報告模組

## 開發進度

### 已完成功能
1. 主控程式 (main_controller.py)
   - 完整的選單系統
   - 模組化設計
   - 使用者輸入驗證
   - 錯誤處理機制

2. 歷史資料下載模組 (M0)
   - 支援多種資料來源
   - 自動資料清理與格式化
   - 資料儲存與管理

3. 策略信號產生模組 (M1)
   - 支援多種技術指標
   - 可擴展的策略框架
   - 信號輸出標準化

4. 策略回測模組 (M2)
   - 支援多種交易模式
   - 考慮手續費和滑點
   - 完整的績效計算
   - 結果自動匯出

5. 績效篩選與報告模組 (M3)
   - 多維度績效分析
   - 彈性篩選條件
   - 多種報告格式支援
   - 自動報告產生

### 最新更新
1. 新增 RSI 策略信號產生器
   - 支援多種 RSI 參數設定
   - 可自定義超買超賣閾值
   - 信號產生邏輯優化

2. 回測系統優化
   - 新增交易時機選擇
   - 支援固定股數和百分比倉位
   - 績效計算精確度提升

3. 報告系統增強
   - 新增 Top N 和 Top % 模式
   - 支援多種排序依據
   - 彈性篩選條件
   - 多格式輸出支援 (CSV/XLSX/HTML)

## 開發日誌

### 2024-03-21: RSI 策略實作與系統優化
...
(此處省略舊日誌)
...
### [2025-06-22] M3/M4 核心工作流修復與穩定性增強
...
(此處省略舊日誌)
...
### [2025-06-23] 全流程檔名重構以包含策略類型

#### 背景
為了提高專案檔案的可讀性和可管理性，避免不同策略產出的檔案互相混淆，決定對 M2 至 M5 的所有輸出檔名進行重構，在檔名中加入策略類型（如 `RSI`, `CROSS`）。

#### 主要變更
1.  **檔名格式統一**：
    *   **舊格式**: `AAPL_signals_all_params_20250623_131410.csv`
    *   **新格式**: `AAPL_RSI_signals_all_params_20250623_131410.csv`
    *   此變更涵蓋了 `signals/` 和 `performance/` 目錄下的所有 `in_sample` 和 `out_sample` 檔案。

2.  **`m2_signal_generator_batch.py`**：
    *   修改了輸出邏輯，從 `param_log` 輸入檔名中解析策略類型，並將其加入到輸出的訊號檔名中。

3.  **`m3_strategy_selector.py`**：
    *   重寫了內部從績效檔名解析 `symbol` 的邏輯，使其能兼容包含策略類型的新檔名格式。

4.  **`m4_1_validation_signal_generator.py`**：
    *   同步修改了其檔名解析與輸出邏輯，確保在驗證流程中也能正確處理並產出新格式的檔名。

5.  **`m5_validation_strategy_selector.py`**：
    *   將其從呼叫共用函式 `selector_utils` 的方式，重構為與 `M3` 類似的獨立模組。
    *   其檔名處理邏輯因直接繼承自輸入檔名，故無需額外修改即可兼容新格式。

#### 成果
整個 M2->M3->M4->M5 的核心工作流程已完全適應新的檔名格式。經過對 AAPL 股票的 `RSI` 和 `CROSS` 策略的完整端對端測試，證明所有模組均能正確地產生、讀取、解析新檔名，並順利完成回測與策略篩選。

---

## 使用說明

### 主控程式操作
1. 執行 `python main_controller.py`
2. 選擇功能編號 (1-5)
3. 依照提示輸入必要參數

### 策略回測流程
1. 選擇 M2 功能
2. 輸入信號檔案路徑
3. 設定回測參數
4. 執行回測
5. 查看結果

### 績效報告產生
1. 選擇 M3 功能
2. 輸入 summary 檔案路徑
3. 設定排序和篩選條件
4. 選擇輸出格式
5. 查看報告

## 待開發功能
1. 即時交易介面
2. 風險管理模組
3. 策略優化工具
4. 視覺化儀表板
5. 多策略組合分析 